<!DOCTYPE html>
<html>

<head>
    <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/dc.min.css">
    <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <link rel="icon" type="image/png" href="images/favicon.png">
    <!-- jquery support -->
    <script src="javascript/jquery-2.1.4.min.js"></script>
    <!-- navbar etc. -->
    <script src="javascript/site.js"></script>
    <!-- charting support -->
    <script src="javascript/d3.min.js" charset="utf-8"></script>
    <script src="javascript/dimple.v2.1.6.min.js"></script>
    <script src="javascript/crossfilter.min.js"></script>
    <script src="javascript/dc.min.js"></script>
    <style type='text/css'>
    p.pagebreakhere {
        page-break-before: always
    }
    </style>
    <script>
    var txID = "unknown";
    var feedSource = new EventSource("/statusfeed/unknown");
    var readySource = new EventSource("/readyfeed/unknown");
    </script>
</head>

<body>
    <div class="container">
        <section class="header">
            <img class="value-img" src="images/search.svg" width="132" height="132">
            <div class="row">
                <div class="twelve columns" style="margin-top: 5%">
                    <h4>NIAS - Naplan Validation</h4>
                    <p>Local NAPLAN Registration Pre-Validation Tool</p>
                    </br>
                </div>
            </div>
        </section>
        <!-- navigation -->
        <div class="navbar-spacer"></div>
        <nav class="navbar">
            <div class="container">
                <ul class="navbar-list">
                    <li class="navbar-item"><a class="navbar-link" href="#upload">Upload Files</a></li>
                    <li class="navbar-item"><a class="navbar-link" href="#analysis">Analysis</a></li>
                    <!-- <li class="navbar-item"><a class="navbar-link" href="#graph">View</a></li> -->
                </ul>
            </div>
        </nav>
        <div class="docs-section" id="upload">
            <div class="row">
                <div class="six columns" style="margin-top: 5%">
                    <h6 class="docs-header">Input File</h6>
                    <input type="file" id="fileInput">
                    <div id="uploadresult"></div>

                    <progress value="1" max="100" id="upload-progress"></progress>
                    <script>
                    window.onload = function() {
                        
                        $("#fetch").prop('disabled', true);
                        
                        var fileInput = document.getElementById('fileInput');
                        // var fileDisplayArea = document.getElementById('fileDisplayArea');

                        fileInput.addEventListener('change', function(e) {
                            $("#fetch").prop('disabled', true);
                            var file = fileInput.files[0];
                            var textType = /text.*/;
                            var textTypeMS = /application.*excel/;

                            if (file.type.match(textType)||file.type.match(textTypeMS)) {
                                var reader = new FileReader();
                                var progressNode = document.getElementById("upload-progress");

                                reader.onprogress = function(event) {
                                    if (event.lengthComputable) {
                                        progressNode.max = event.total;
                                        progressNode.value = event.loaded;
                                    }
                                };

                                reader.onload = function(e) {
                                    // fileDisplayArea.innerText = reader.result;
                                    $.post("/naplan/reg/sa", reader.result, function(data) {
                                        txID = data
                                        // console.log(txID)

                                        ref = "/statusfeed/" + txID;
                                        feedSource.close();
                                        feedSource = new EventSource(ref);

                                        feedSource.onmessage = function(event) {
                                            var data = JSON.parse(event.data);

                                            $("#result").empty();

                                            var svg = dimple.newSvg("#result", 400, 200);
                                            var chart = new dimple.chart(svg, data);
                                            chart.addCategoryAxis("y", "v_type");
                                            chart.addMeasureAxis("x", "count");
                                            chart.addSeries(null, dimple.plot.bar);
                                            chart.draw();

                                        };

                                        ref = "/readyfeed/" + txID
                                        readySource.close();
                                        readySource = new EventSource(ref);
                                        // renderOnce = true;

                                        readySource.onmessage = function(event) {

                                            if (txID == event.data) {$("#fetch").prop('disabled', false);}
                                        //     if (renderOnce) {
                                        //         renderAnalysis(txID);
                                        //         renderOnce = false;
                                        //     }

                                                
                                        };


                                        // document.getElementById("uploadresult").innerHTML = txID;
                                        document.getElementById("uploadresult").innerHTML = "File Accepted";
                                    });
                                }

                                // reader.readAsText(file);    
                                reader.readAsBinaryString(file);
                            } else {
                                document.getElementById("uploadresult").innerHTML = "File Type Not Supported";
                            }
                        });
                    }
                    </script>
                </div>
                <div class="six columns" style="margin-top: 5%">
                    <h6 class="docs-header">Validation Progress</h6>
                    <div id="result"></div>
                    <script>
                    if (typeof(EventSource) !== "undefined") {
                        data = null;
                        var svg = dimple.newSvg("#result", 400, 200);
                        var chart = new dimple.chart(svg, data);
                        chart.addCategoryAxis("y", "v_type");
                        chart.addMeasureAxis("x", "count");
                        chart.addSeries(null, dimple.plot.bar);
                        chart.draw();
                    } else {
                        document.getElementById("result").innerHTML = "Sorry, your browser does not support server-sent events...";
                    }
                    </script>
                </div>
            </div>
            <div class="row">
                <div class="twelve columns">
                    <button id="fetch" class="button-primary">Fetch Results</button>
                    <script>
                        $( "#fetch" ).click(function() {
                          renderAnalysis(txID);
                          // shut down the polling until the next file is loaded
                          feedSource.close();
                          readySource.close();
                        });
                    </script>
                </div>

            </div>
            <div class="docs-section" id="analysis">
                <div class="row">
                    <div class="twelve columns" style="margin-top: 5%">
                        <h6 class="docs-header">Validation Analysis Results</h6>
                    </div>
                </div>
                <div class="row">
                    <div class="six columns" style="margin-top: 5%">
                        <div id="errors-chart">
                            <strong>Validation Errors by Record Order</strong>
                            <span class="reset" style="display: none;"></span>
                            <!-- <span class="reset" style="display: none;">range: <span class="filter"></span></span> -->
                            <a class="reset" href="javascript:dc.filterAll(); dc.renderAll();" style="display: none;">reset</a>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                    <div class="six columns" style="margin-top: 5%">
                        <div id="errors-by-type-chart">
                            <strong>Errors By Validaiton Type</strong>
                            <a class="reset" href="javascript:dc.filterAll(); dc.renderAll();" style="display: none;">reset</a>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="twelve columns" style="margin-top: 5%">
                        <div class="dc-data-count">
                            <span class="filter-count"></span> selected out of <span class="total-count"></span> records | <a href="javascript:dc.filterAll(); dc.renderAll();">reset</a>
                        </div>
                    </div>
                    <div class="twelve columns" style="margin-top: 5%">
                        <table class="table table-hover dc-data-table">
                            <thead>
                                <tr>
                                    <th>Original Line No.</th>
                                    <th>Error Type</th>
                                    <th>Error Field</th>
                                    <th>Error Description</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="twelve columns" style="margin-top: 5%">
                        </br>
                        </br>
                        </br>
                        </br>
                    </div>
                </div>
                <script>
                function renderAnalysis(txID) {
                    // var errorsBarChart = dc.barChart("#errors-chart");
                    // var errorsByTypeChart = dc.rowChart('#errors-by-type-chart');
                    // var dataTable = dc.dataTable('.dc-data-table');
                    // var verrorsCount = dc.dataCount('.dc-data-count');


                    // var errorData;

                    ref = "/data/" + txID;
                    d3.json(ref, function(error, data) {
        
                        var errorsBarChart = dc.barChart("#errors-chart");
                        var errorsByTypeChart = dc.rowChart('#errors-by-type-chart');
                        var dataTable = dc.dataTable('.dc-data-table');
                        var verrorsCount = dc.dataCount('.dc-data-count');
                        var errorData = data;

                        // normalize/parse data so dc can correctly sort & bin them
                        errorData.forEach(function(d) {
                            d.originalLine = +d.originalLine;
                        });
                        // console.log(errorData);

                        var ndx = crossfilter(errorData);
                        var all = ndx.groupAll();

                        var lineDim = ndx.dimension(function(d) {
                            return d.originalLine;
                        });

                        var typeDim = ndx.dimension(function(d) {
                            return d.validationType;
                        });
                        var validationTypesGroup = typeDim.group();

                        var allDim = ndx.dimension(function(d) {
                            return d;
                        });

                        // var countPerLine = lineDim.group().reduceCount(function(d) {
                        //     return d.originalLine;
                        // });

                        var lineGroup = lineDim.group();

                        // var countPerLine = lineDim.group().reduceSum(function(d) {return d.OriginalLine;});

                        errorsBarChart
                            .width(350)
                            .height(190)
                            .margins({
                                top: 20,
                                right: 0,
                                bottom: 0,
                                left: 0
                            })
                            .gap(1)
                            .x(d3.scale.linear().domain([0, 200000]))
                            .elasticX(true)
                            .elasticY(true)
                            .dimension(lineDim)
                            .group(lineGroup);

                        errorsBarChart.dimension(lineDim);

                        errorsByTypeChart
                            .width(350)
                            .height(190)
                            .margins({
                                top: 20,
                                left: 10,
                                right: 10,
                                bottom: 20
                            })
                            .group(validationTypesGroup)
                            .dimension(typeDim)
                            .title(function(d) {
                                return d.value;
                            })
                            .elasticX(true)
                            .xAxis().ticks(4);


                        verrorsCount
                            .dimension(ndx)
                            .group(all);


                        dataTable
                        // .width(900)
                        // .height(800)
                            .dimension(allDim)
                            .group(function(d) {
                                // return 'dc.js insists on putting a row here so I remove it using JS';
                                // return d.originalLine;
                                return 'Errors ordered by original file line number (table shows first 100 errors)'
                            })
                            .size(100)
                            .columns([
                                // function (d) { return d.txID; },
                                function(d) {
                                    return d.originalLine;
                                },
                                function(d) {
                                    return d.validationType;
                                },
                                function(d) {
                                    return d.errField;
                                },
                                function(d) {
                                    return d.description;
                                }
                            ])
                            .sortBy(function(d) {
                                return d.originalLine;
                            })
                            .order(d3.ascending)
                            .on('renderlet', function(table) {
                                // each time table is rendered remove nasty extra row dc.js insists on adding
                                // table.select('tr.dc-table-group').remove();
                                table.selectAll('.dc-table-group').classed('info', true);
                            });

                        dc.renderAll();

                        // dc.redrawAll();


                    });


                }
                </script>
            </div>
        </div>
        <!-- container -->
</body>

</html>